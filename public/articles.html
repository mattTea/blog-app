<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" type="text/css" href="style.css"/>
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Questrial"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<title>B.A(ng)</title>

<style></style>
</head>

<body>

<!-- Navigation -->
<nav>
    <ul class="w3-navbar w3-black">
        <li><a href="index.html">Home</a></li>
        <li><a href="#" style="font-weight:bold">Blogs</a></li>
        <li><a href="about.html">About</a></li>
    </ul>
</nav>

<!-- Headline -->
<div id="headline">
    <div class="container">
        <header>
            <h1>B.A(ng)</h1>
            <h2>from business analyst to engineer</h2>
        </header>
        <div id="blurb">
            <p>chatting about my experiences learning to code<br>and still trying to be a business analyst</p>
        </div>
    </div>
</div>


<!-- Blog Index & Details -->
<div id="blogs">
    <div class="container">
        <div id="blog-index">
            <h3>the blogs...</h3>
            <a href="#blog-title"><table id="index">
                <tr></tr>
            </table></a>
        </div>

        <div id="blog-details">
            <div id="blog-title" style="color:saddlebrown;font-size:150%;font-weight:bold;margin:25px;text-align:center"></div>
            <div id="blog-author" style="font-weight:bold;text-align:center"></div>
            <div id="blog-createdDate" style="font-style:italic;text-align:center"></div>
            <img id="blog-image" src="" alt="blog image"></img>
            <div id="blog-content"></div>

            <div id="comments">
                <div id="comment-header">
                    <h4>comments...</h4>
                </div>
                <div id="comment-date"></div>
                <div id="blog-comments"></div>
            </div>
            
            <div id="newComment">
                <textarea id="comments-box" name="newComment" rows="4" cols="50" placeholder="share you thoughts..."></textarea>                
                <button id="submit-button" value="Submit">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- TODO comments field
1. Show blog comments metafield (if none, show message "no comments")
2. DONE Add newComments textarea and submit button to page
3. See if poss to POST/APPEND date<br>text<br><br> to the blog comments metafield
-->


<!-- Footer -->
<footer id="footer">
    <div class="container" style="text-align:center">
        <p>mattTea | B.A(ng)</p>
    </div>
</footer>



</body>

<script>
//when page has fully rendered then execute this code
$(document).ready(function () {

    $("#blog-details").hide();

    //display index of blog titles
    var blogIndex = "https://api.cosmicjs.com/v1/matttea-blog-app/object-type/articles";
    $.get(blogIndex, function (data) {
        var tr;
        if (data.objects.length > 0) {
            for (var i = 0; i < data.objects.length; i++) {                         
                tr = $('<tr/>');
                tr.append("<td>" + data.objects[i].title + "</td>");
                $("#index").append(tr);
            }
            console.log('index query finished, got', data);
        } else {
            $("#index").empty();
            $("#index").append('Oops! Something went wrong, no blogs found.');
            console.log('query finished, no blogs found');                
        }
    });

    //blog display on index row click
    $('#index').on('click', 'tr', function() {
        console.log('You clicked row ' + ($(this).index()));
        
        var currentRow = $(this).closest("tr");
        var cellText = currentRow.find("td:eq(0)").text();
        console.log('The content of this table row is ' + cellText);
        
        var blogIndexClick = "https://api.cosmicjs.com/v1/matttea-blog-app/object-type/articles/search?metafield_key=headline&metafield_value=" + cellText;

        $.get(blogIndexClick, function (data) {
            if (!!data.objects) {
                var title = data.objects[0].title;
                var author = data.objects[0].metadata.author.title;
                var createdDate = data.objects[0].created_at;
                var displayDate = createdDate.charAt(8) + createdDate.charAt(9) + '/' + createdDate.charAt(5) + createdDate.charAt(6) + '/' + createdDate.charAt(0) + createdDate.charAt(1) + createdDate.charAt(2) + createdDate.charAt(3);
                var blogImage = data.objects[0].metadata.hero.url;
                var content = data.objects[0].content;
                if (!!data.objects[0].metadata.comment) {
                    var rawCommentDate = data.objects[0].metadata.comment.created_at;
                    var commentDate = rawCommentDate.charAt(8) + rawCommentDate.charAt(9) + '/' + rawCommentDate.charAt(5) + rawCommentDate.charAt(6) + '/' + rawCommentDate.charAt(0) + rawCommentDate.charAt(1) + rawCommentDate.charAt(2) + rawCommentDate.charAt(3);
                    var comments = data.objects[0].metadata.comment.content;
                    $("#comments").show();
                    $("#comment-date").empty();
                    $("#blog-comments").empty();
                    $("#comment-date").append(commentDate);
                    $("#blog-comments").append(comments);                        
                } else {
                    $("#comments").hide();
                    $("#comment-date").empty();
                    $("#blog-comments").empty();
                }

                $("#blog-details").show();                
                $("#blog-title").html(title);
                $("#blog-author").html(author);
                $("#blog-createdDate").html(displayDate);
                $("#blog-image").attr("src", blogImage);
                $("#blog-content").html(content);
                console.log('query finished, got', data);                      
            } else {
                $("#blog-title").empty();
                $("#blog-author").empty();
                $("#blog-createdDate").empty();
                $("#blog-image").empty();
                $("#blog-content").empty();
                $("#comments").hide();
                $("#comment-date").empty();
                $("#blog-comments").empty();

                $("#blog-content").append('Sorry, that link didn\'t work. Please try searching by title.');
                console.log('query finished, no article found');
            }
        });
    });

    //POST /comments to Cosmic
    $("#submit-button").click(function (element) {
        
        var newComment = $("#comments-box").val();
        console.log('newComment:', newComment);   
        var d = new Date();
        var date = d.getDate() + '-' + (d.getMonth()+1) + '-' + d.getFullYear();
        var commentValue = date + "<br>" + newComment + "<br><br>";

        console.log(commentValue);

        //PUT https://api.cosmicjs.com/v1/matttea-blog-app/edit-object
        var commentPut = "https://api.cosmicjs.com/v1/matttea-blog-app/edit-object";
        
        var blogComment =
            {
                slug: 'test-the-beginnings-of-addiction', //currentBlogSlug (hard-coded slug for test)
                //think i might need to put all metafields in? but would rather not
                metafields: [
                    {
                        title: 'Comments',
                        key: 'comments',
                        value: commentValue,
                        type: 'text'
                    }
                ]
            }

        var blogCommentJson = JSON.stringify(blogComment);
        console.log('blogCommentJson: ' + blogCommentJson);

        // BELOW commented out as PUT call was clearing all other metafields apart from Comments!
        // $.ajax({
        //     url: commentPut,
        //     method: 'PUT',
        //     contentType: 'application/json',
        //     data: blogCommentJson,
        //     success: function(){
        //         console.log('PUT action complete');
        //     }
        // });
        $("#comments-box").val('');
    });
});

</script>



</html>